<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 18px;
  font-size: 20px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 18px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 14px;
}

.metric {
  background: #0f172a;
  padding: 14px;
  border-radius: 10px;
}

.metric-title {
  font-size: 12px;
  color: #9ca3af;
}

.metric-value {
  font-size: 20px;
  font-weight: 600;
  margin-top: 6px;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

.small { font-size: 12px; color: #9ca3af; }
</style>
</head>

<body>

<header>
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
  <div>
    <div style="font-size:20px;font-weight:600;">Pendle Monitoring</div>
    <div class="small">Auto-refresh every 60 seconds</div>
  </div>
  <div id="statusBanner" style="
      padding:8px 14px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      margin-top:8px;">
    Checking status...
  </div>
</div>
</header>

<div class="section">

<div class="card">
<h3>üìä Ingestion Health</h3>
<div id="ingestionMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üìà Traffic Overview</h3>
<div id="trafficMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üö® Alerts</h3>
<div id="alertMetrics" class="grid"></div>
</div>

</div>

<script>

// üîê Password session
let password = sessionStorage.getItem("admin_secret");

if (!password) {
  password = prompt("Enter Admin Password:");
  if (password) sessionStorage.setItem("admin_secret", password);
}

async function fetchMonitor() {
  const res = await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    {
      headers: { "x-admin-secret": password }
    }
  );

  if (!res.ok) {
    sessionStorage.removeItem("admin_secret");
    alert("Authentication failed");
    location.reload();
    return null;
  }

  return await res.json();
}

function metric(title, value, colorClass="") {
  return `
    <div class="metric">
      <div class="metric-title">${title}</div>
      <div class="metric-value ${colorClass}">${value}</div>
    </div>
  `;
}

async function loadMonitoring() {
  const res = await fetchMonitor();
  if (!res) return;

  const { ingestion, traffic, alerts } = res;

  // ===============================
// üü¢ STATUS BANNER + NEXT SNAPSHOT
// ===============================

const mins = ingestion.minutes_since_latest;
const expectedInterval = 60;
const minsToNext = expectedInterval - mins;

let banner = document.getElementById("statusBanner");

if (mins <= 60) {
  banner.style.background = "#052e16";
  banner.style.color = "#22c55e";
  banner.innerHTML = `üü¢ Healthy ‚Äî Next snapshot in ~${minsToNext} min`;
}
else if (mins <= 75) {
  banner.style.background = "#422006";
  banner.style.color = "#f59e0b";
  banner.innerHTML = `üü° Delayed ‚Äî Snapshot overdue by ${mins - 60} min`;
}
else {
  banner.style.background = "#3f0f12";
  banner.style.color = "#ef4444";
  banner.innerHTML = `üî¥ Critical ‚Äî No snapshot for ${mins} min`;
}

  // ===============================
  // INGESTION
  // ===============================

  let healthColor = "good";
  if (ingestion.health_score < 90) healthColor = "warn";
  if (ingestion.health_score < 70) healthColor = "bad";

  document.getElementById("ingestionMetrics").innerHTML =
    metric("Health Score", ingestion.health_score + "/100", healthColor) +
    metric("Rows", ingestion.row_count) +
    metric("Chains", ingestion.chain_count) +
    metric("Minutes Since Snapshot", ingestion.minutes_since_latest) +
    metric("Row Œî %", ingestion.row_change_percent + "%") +
    metric("Interval Drift", ingestion.interval_drift_minutes + "m") +
    metric("SLA", ingestion.sla_percent + "%") +
    metric("Avg Duration", ingestion.avg_duration_ms + " ms") +
    metric("P95 Duration", ingestion.p95_duration_ms + " ms") +
    metric("Max Duration", ingestion.max_duration_ms + " ms");

  // ===============================
  // TRAFFIC
  // ===============================

  document.getElementById("trafficMetrics").innerHTML =
    metric("Today Visits", traffic.today_total) +
    metric("Today Unique", traffic.today_unique) +
    metric("Yesterday Visits", traffic.yesterday_total) +
    metric("Yesterday Unique", traffic.yesterday_unique) +
    metric("Growth %", traffic.growth_percent + "%") +
    metric("30d Total", traffic.total_30_days) +
    metric("30d Unique", traffic.unique_30_days);

  // ===============================
  // ALERTS
  // ===============================

  document.getElementById("alertMetrics").innerHTML =
    metric("Alerts (Last 48 Runs)", alerts.total_last_48_runs) +
    metric("Last Alert", alerts.last_alert_time || "None");
}

loadMonitoring();
setInterval(loadMonitoring, 60000);

</script>

</body>
</html>
