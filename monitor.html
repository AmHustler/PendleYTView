<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 18px;
  font-size: 20px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 16px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 16px;
}

.metric {
  font-size: 26px;
  font-weight: 700;
}

.small {
  font-size: 12px;
  color: #9ca3af;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

.divider {
  height: 1px;
  background: #1f2937;
  margin: 14px 0;
}
</style>
</head>

<body>

<header>
Pendle Monitoring
<div class="small">Auto refresh every 60 seconds</div>
</header>

<div class="section">

<div class="grid">

<div class="card">
<strong>ðŸ“Š Ingestion Health</strong>
<div id="ingestionBlock"></div>
</div>

<div class="card">
<strong>ðŸ“ˆ Traffic Overview</strong>
<div id="trafficBlock"></div>
</div>

<div class="card">
<strong>ðŸš¨ Alerts</strong>
<div id="alertBlock"></div>
</div>

</div>
</div>

<script>

const WORKER_URL = "https://pendle-worker.haripavanveera.workers.dev/monitor";

let ADMIN_SECRET = sessionStorage.getItem("admin_secret");

if (!ADMIN_SECRET) {
  ADMIN_SECRET = prompt("Enter admin password:");
  if (ADMIN_SECRET) {
    sessionStorage.setItem("admin_secret", ADMIN_SECRET);
  }
}

async function fetchData() {
  const res = await fetch(WORKER_URL, {
    headers: { "x-admin-secret": ADMIN_SECRET }
  });

  if (!res.ok) {
    sessionStorage.removeItem("admin_secret");
    alert("Authentication failed.");
    location.reload();
    throw new Error("Unauthorized");
  }

  return await res.json();
}

function renderIngestion(data) {
  const block = document.getElementById("ingestionBlock");

  let status = "Healthy";
  let color = "good";

  if (data.health_score < 70) {
    status = "Critical";
    color = "bad";
  } else if (data.health_score < 90) {
    status = "Degraded";
    color = "warn";
  }

  block.innerHTML = `
    <div class="metric ${color}">
      ${data.health_score}/100 â€” ${status}
    </div>

    <div class="small">
      Last Snapshot: ${data.latest_snapshot}<br/>
      ${data.minutes_since_latest} minutes ago<br/>
      Rows: ${data.row_count} 
      (${data.row_change_percent > 0 ? "+" : ""}${data.row_change_percent}%)<br/>
      Chains: ${data.chain_count}<br/>
      Duration: ${data.duration_ms} ms
    </div>

    <div class="divider"></div>

    <div class="small">
      SLA: ${data.sla_percent}%<br/>
      Interval Drift: ${data.interval_drift_minutes} min<br/>
      Avg Duration: ${data.avg_duration_ms} ms<br/>
      P95 Duration: ${data.p95_duration_ms} ms<br/>
      Max Duration: ${data.max_duration_ms} ms<br/>
      Runs: ${data.total_runs}
    </div>
  `;
}

function renderTraffic(data) {
  const block = document.getElementById("trafficBlock");

  const growthClass =
    data.growth_percent > 0 ? "good" :
    data.growth_percent < 0 ? "bad" : "warn";

  block.innerHTML = `
    <div class="metric">${data.today_total} visits today</div>
    <div class="small">
      Unique Today: ${data.today_unique}<br/>
      Yesterday: ${data.yesterday_total}<br/>
      Unique Yesterday: ${data.yesterday_unique}<br/>
      Growth: <span class="${growthClass}">${data.growth_percent}%</span>
    </div>

    <div class="divider"></div>

    <div class="small">
      30 Day Total: ${data.total_30_days}<br/>
      30 Day Unique: ${data.unique_30_days}
    </div>
  `;
}

function renderAlerts(data) {
  const block = document.getElementById("alertBlock");

  const alertClass =
    data.total_last_48_runs === 0 ? "good" : "bad";

  block.innerHTML = `
    <div class="metric ${alertClass}">
      ${data.total_last_48_runs} Alerts (last 48 runs)
    </div>
    <div class="small">
      Last Alert: ${data.last_alert_time ?? "None"}
    </div>
  `;
}

async function load() {
  const data = await fetchData();

  renderIngestion(data.ingestion);
  renderTraffic(data.traffic);
  renderAlerts(data.alerts);
}

setInterval(load, 60000);
load();

</script>

</body>
</html>
