<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pendle Sovereign Control Surface</title>

<style>
:root{
  --bg:#0b1220;
  --card:rgba(18,24,40,0.75);
  --border:rgba(255,255,255,0.06);
  --text:#e6edf3;
  --muted:#8b98b8;
  --green:#22c55e;
  --amber:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --cyan:#06b6d4;
}

body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:radial-gradient(circle at 50% -10%, #1b2440 0%, #0b1220 70%);
  color:var(--text);
}

header{
  padding:28px 40px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{font-size:22px;font-weight:600;}
.subtitle{font-size:12px;color:var(--muted);}

#statusBanner{
  padding:10px 18px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
}

#executiveStrip{
  padding:14px 40px;
  border-bottom:1px solid var(--border);
  font-size:13px;
  color:var(--muted);
}

.wrapper{
  padding:32px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(480px,1fr));
  gap:28px;
}

.card{
  background:var(--card);
  backdrop-filter:blur(14px);
  border-radius:16px;
  padding:22px;
  border:1px solid var(--border);
}

.card h3{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--muted);
  margin-bottom:18px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
}

  .tooltip{
  right:auto;
  max-width:220px;
  word-wrap:break-word;
  }

  .metric:last-child .tooltip{
  left:auto;
  right:0;
  }

.metric{
  background:rgba(15,22,40,0.7);
  padding:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
  position:relative;
}

.metric-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.metric-title{
  font-size:10px;
  text-transform:uppercase;
  color:var(--muted);
}

.metric-value{
  font-size:16px;
  font-weight:600;
  margin-top:4px;
}

.info-icon{
  width:16px;
  height:16px;
  border-radius:50%;
  background:rgba(255,255,255,0.08);
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:0.2s ease;
}

.info-icon:hover{
  background:rgba(139,92,246,0.4);
}

.tooltip{
  position:absolute;
  bottom:100%;
  left:0;
  margin-bottom:8px;
  background:#111827;
  border:1px solid rgba(255,255,255,0.08);
  padding:10px;
  border-radius:8px;
  font-size:12px;
  max-width:220px;
  display:none;
  z-index:999;
}

.progress{
  height:5px;
  background:rgba(255,255,255,0.06);
  border-radius:4px;
  margin-top:6px;
}

.progress-fill{
  height:100%;
  border-radius:4px;
}

.radar svg{
  width:100%;
  max-width:420px;
  height:auto;
}

.sparkline svg{
  width:100%;
  height:70px;
}

.index-panel{
  text-align:center;
  padding:20px;
  border-radius:12px;
  margin-bottom:18px;
  background:rgba(139,92,246,0.08);
  border:1px solid rgba(139,92,246,0.3);
}

.index-score{font-size:36px;font-weight:700;}
.small{font-size:12px;color:var(--muted);}
</style>
</head>

<body>

<header>
  <div>
    <div class="title">Pendle Sovereign Control Surface</div>
    <div class="subtitle">Autonomous Quant Risk Intelligence Layer</div>
  </div>
  <div id="statusBanner">Initializing...</div>
</header>

<div id="executiveStrip"></div>

<div class="wrapper">

<div class="card">
  <h3>System Stability</h3>
  <div id="stabilityIndex"></div>
</div>

<div class="card">
  <h3>Operational Matrix</h3>
  <div id="opsGrid" class="grid"></div>
</div>

<div class="card">
  <h3>Risk Radar</h3>
  <div id="riskRadar" style="display:flex;justify-content:center;"></div>
</div>

<div class="card">
  <h3>Trend Momentum</h3>
  <div id="trendSparkline"></div>
</div>

<div class="card">
  <h3>AI Executive Summary</h3>
  <div id="aiNarrative"></div>
</div>

<div class="card">
  <h3>Autonomous Intelligence Layer</h3>
  <div id="autonomyPanel" class="grid"></div>
</div>

</div>

<script>
let password=sessionStorage.getItem("admin_secret");
if(!password){
  password=prompt("Enter Admin Password:");
  if(password) sessionStorage.setItem("admin_secret",password);
}

async function fetchMonitor(){
  const res=await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    {headers:{"x-admin-secret":password}}
  );
  if(!res.ok){
    sessionStorage.removeItem("admin_secret");
    location.reload();
    return null;
  }
  return await res.json();
}

function toggleTooltip(id){
  const el=document.getElementById(id);
  const isVisible = el.classList.contains("active");
  document.querySelectorAll(".tooltip").forEach(t=>{
    t.classList.remove("active");
    t.style.display="none";
  });
  if(!isVisible){
    el.classList.add("active");
    el.style.display="block";
  }
}

function metric(title,value,bar,color,desc){
  const id="tip_"+Math.random().toString(36).slice(2,8);
  return `
  <div class="metric">
    <div class="metric-header">
      <div class="metric-title">${title}</div>
      <div class="info-icon" onclick="toggleTooltip('${id}')">i</div>
    </div>
    <div class="metric-value">${value}</div>
    ${bar?`<div class="progress">
        <div class="progress-fill" style="width:${bar}%;background:${color}"></div>
      </div>`:""}
    <div class="tooltip" id="${id}">${desc}</div>
  </div>`;
}

function renderRadar(values){
  const size=420;
  const center=size/2;
  const radius=120;
  const labels=["Delay","Anomaly","Volatility","Health"];
  let poly="",axes="",grid="",dots="",vals="",texts="";

  for(let r=1;r<=4;r++){
    grid+=`<circle cx="${center}" cy="${center}" r="${(r/4)*radius}"
    fill="none" stroke="rgba(255,255,255,0.05)"/>`;
  }

  values.forEach((v,i)=>{
  const angle=(Math.PI*2/values.length)*i - Math.PI/2;
  const ax=center+radius*Math.cos(angle);
  const ay=center+radius*Math.sin(angle);
  axes+=`<line x1="${center}" y1="${center}" x2="${ax}" y2="${ay}" 
  stroke="rgba(255,255,255,0.06)" stroke-width="1"/>`;
});

  values.forEach((v,i)=>{
    const angle=(Math.PI*2/values.length)*i - Math.PI/2;
    const scaled=(v/100)*radius;
    const x=center+scaled*Math.cos(angle);
    const y=center+scaled*Math.sin(angle);
    poly+=`${x},${y} `;
    dots+=`<circle cx="${x}" cy="${y}" r="4" fill="#8b5cf6" stroke="#fff"/>`;
    vals+=`<text x="${x}" y="${y-10}" font-size="11" fill="#fff" text-anchor="middle">${Math.round(v)}</text>`;
    const lx=center+(radius+32)*Math.cos(angle);
    const ly=center+(radius+32)*Math.sin(angle);
    texts+=`<text x="${lx}" y="${ly}" font-size="12" fill="#8b98b8" text-anchor="middle">${labels[i]}</text>`;
  });

  return `
  <svg width="${size}" height="${size}">
    ${grid}
    ${axes}
    <polygon points="${poly}" fill="rgba(139,92,246,0.25)" stroke="#8b5cf6" stroke-width="2"/>
    ${dots}
    ${vals}
    ${texts}
  </svg>`;
}

function renderSparkline(values){
  if(values.length<3) return "<div class='small'>Collecting...</div>";
  const width=500,height=70;
  const max=Math.max(...values,100);
const min=Math.min(...values,0);
  const range=max-min||1;
  const points=values.map((v,i)=>{
    const x=(i/(values.length-1))*width;
    const y=height-((v-min)/range)*height;
    return `${x},${y}`;
  }).join(" ");
  const delta=values[values.length-1]-values[values.length-2];
  let label="Flat",color="#06b6d4";
  if(delta>2){label="Uptrend";color="#22c55e";}
  if(delta<-2){label="Downtrend";color="#ef4444";}
  return `
  <div class="small" style="margin-bottom:6px">Trend: ${label}</div>
  <svg viewBox="0 0 ${width} ${height}">
    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2"/>
  </svg>`;
}

async function load(){
  const res=await fetchMonitor();
  if(!res) return;
  const {ingestion}=res;

  const avg=ingestion.avg_duration_ms;
  const p95=ingestion.p95_duration_ms;
  const latest=ingestion.duration_ms;
  const drift=parseFloat(ingestion.interval_drift_minutes);
  const mins=ingestion.minutes_since_latest;
  /* ===== STATUS BANNER ===== */
const banner=document.getElementById("statusBanner");

if(mins <= 60){
  banner.style.background="rgba(34,197,94,0.15)";
  banner.style.color="#22c55e";
  banner.innerHTML="SYSTEM STABLE";
}
else if(mins <= 75){
  banner.style.background="rgba(245,158,11,0.15)";
  banner.style.color="#f59e0b";
  banner.innerHTML="SYSTEM DELAYED";
}
else{
  banner.style.background="rgba(239,68,68,0.15)";
  banner.style.color="#ef4444";
  banner.innerHTML="SYSTEM DEGRADED";
}
  const volatility=(p95-avg)/avg;
  let z = 0;
const std = (p95 - avg) / 1.645;
if (std > 0) {
  z = (latest - avg) / std;
}
  const anomaly=Math.min(Math.abs(z)*20,100);
  const delayRisk=Math.min((mins>50?25:0)+(drift>5?20:0)+(volatility>0.4?20:0),100);
  const composite=Math.round(ingestion.health_score*0.5+(100-delayRisk)*0.3+(100-anomaly)*0.2);

  function push(k,v){
    let arr=JSON.parse(localStorage.getItem(k)||"[]");
    arr.push(v); if(arr.length>20) arr.shift();
    localStorage.setItem(k,JSON.stringify(arr));
  }
  push("stability",composite);
  const hist=JSON.parse(localStorage.getItem("stability"));

  document.getElementById("executiveStrip").innerHTML=
    `Stability ${composite} | Delay ${delayRisk}% | Anomaly ${Math.round(anomaly)}%`;

  document.getElementById("stabilityIndex").innerHTML=
    `<div class="index-panel">
      <div class="index-score">${composite}</div>
      <div class="small">Institutional Stability Index</div>
    </div>`;

  document.getElementById("opsGrid").innerHTML=
    metric("SLA",ingestion.sla_percent+"%",null,null,"Service level agreement compliance.")+
    metric("Delay Risk",delayRisk+"%",delayRisk,"#ef4444","Probability next cycle exceeds time threshold.")+
    metric("Anomaly",Math.round(anomaly)+"%",anomaly,"#f59e0b","Statistical deviation from normal duration.")+
    metric("Volatility",Math.round(volatility*100)+"%",volatility*100,"#8b5cf6","Duration spread vs baseline.")+
    metric("Avg",avg+" ms",null,null,"Mean ingestion duration.")+
    metric("P95",p95+" ms",null,null,"95th percentile duration.");

  document.getElementById("riskRadar").innerHTML=
    renderRadar([delayRisk,anomaly,volatility*100,ingestion.health_score]);

  document.getElementById("trendSparkline").innerHTML=
    renderSparkline(hist);

  document.getElementById("aiNarrative").innerHTML=
    `<div class="small">
      Composite stability ${composite}. 
      Delay risk ${delayRisk}%. 
      Anomaly intensity ${Math.round(anomaly)}%.
      Volatility regime ${volatility>0.6?"High":volatility>0.3?"Moderate":"Low"}.
    </div>`;

  document.getElementById("autonomyPanel").innerHTML=
    metric("Composite",composite,null,null,"Weighted adaptive score.")+
    metric("Z-Score",z.toFixed(2),null,null,"Standard deviation from mean duration.")+
    metric("Drift",drift+"m",null,null,"Time drift from expected interval.")+
    metric("Minutes Since",mins,null,null,"Time since last snapshot.");
}

load();
setInterval(load,60000);
</script>

</body>
</html>
