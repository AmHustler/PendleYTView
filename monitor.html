<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 18px;
  font-size: 20px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 18px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 14px;
}

.metric {
  background: #0f172a;
  padding: 14px;
  border-radius: 10px;
}

.metric-title {
  font-size: 12px;
  color: #9ca3af;
}

.metric-value {
  font-size: 20px;
  font-weight: 600;
  margin-top: 6px;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

.small { font-size: 12px; color: #9ca3af; }
</style>
</head>

<body>

<header>
Pendle Monitoring
<div class="small">Auto-refresh every 60 seconds</div>
</header>

<div class="section">

<div class="card">
<h3>üìä Ingestion Health</h3>
<div id="ingestionMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üìà Traffic Overview</h3>
<div id="trafficMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üö® Alerts</h3>
<div id="alertMetrics" class="grid"></div>
</div>

</div>

<script>

// üîê Password session
let password = sessionStorage.getItem("admin_secret");

if (!password) {
  password = prompt("Enter Admin Password:");
  if (password) sessionStorage.setItem("admin_secret", password);
}

async function fetchMonitor() {
  const res = await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    {
      headers: { "x-admin-secret": password }
    }
  );

  if (!res.ok) {
    sessionStorage.removeItem("admin_secret");
    alert("Authentication failed");
    location.reload();
    return null;
  }

  return await res.json();
}

function metric(title, value, colorClass="") {
  return `
    <div class="metric">
      <div class="metric-title">${title}</div>
      <div class="metric-value ${colorClass}">${value}</div>
    </div>
  `;
}

async function load() {
  const data = await fetchMonitor();
  if (!data) return;

  const ing = data.ingestion;
  const traffic = data.traffic;
  const alerts = data.alerts;

  // =======================
  // Ingestion Section
  // =======================
  document.getElementById("ingestionMetrics").innerHTML =
    metric("Last Snapshot", ing.latest_snapshot) +
    metric("Rows", ing.row_count) +
    metric("Chains", ing.chain_count) +
    metric("Duration (ms)", ing.duration_ms) +
    metric("SLA %", ing.sla_percent,
      ing.sla_percent >= 98 ? "good" :
      ing.sla_percent >= 95 ? "warn" : "bad") +
    metric("Avg Duration", ing.avg_duration_ms) +
    metric("Max Duration", ing.max_duration_ms);

  // =======================
  // Traffic Section
  // =======================
  document.getElementById("trafficMetrics").innerHTML =
    metric("Today Visits", traffic.today_total) +
    metric("Today Unique", traffic.today_unique) +
    metric("Yesterday Visits", traffic.yesterday_total) +
    metric("Yesterday Unique", traffic.yesterday_unique) +
    metric("Growth %", traffic.growth_percent,
      traffic.growth_percent > 0 ? "good" :
      traffic.growth_percent < 0 ? "bad" : "") +
    metric("30d Total", traffic.total_30_days) +
    metric("30d Unique", traffic.unique_30_days);

  // =======================
  // Alerts Section
  // =======================
  document.getElementById("alertMetrics").innerHTML =
    metric("Total Alerts (30d)", alerts.total_last_30_days) +
    metric("Last Alert Time", alerts.last_alert_time ?? "None",
      alerts.last_alert_time ? "warn" : "good");
}

load();
setInterval(load, 60000);

</script>

</body>
</html>
