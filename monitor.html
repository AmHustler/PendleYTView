<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 16px;
  font-size: 18px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 16px;
}

.card {
  background: #111827;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 14px;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #1f2937;
}

thead {
  background: #0f172a;
}

.small {
  font-size: 12px;
  color: #9ca3af;
}

.sparkline {
  width: 100%;
  height: 50px;
}

.badge {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
}
.badge-green { background: #065f46; }
.badge-yellow { background: #78350f; }
.badge-red { background: #7f1d1d; }
</style>
</head>

<body>

<header>
Pendle Monitoring
<div class="small" id="refreshInfo"></div>
</header>

<div class="section">

<div class="card">
<strong>System Health</strong>
<div id="healthStatus"></div>
</div>

<div class="card">
<strong>SLA & Performance</strong>
<div id="slaStats"></div>
<svg id="rowTrend" class="sparkline"></svg>
<svg id="durationTrend" class="sparkline"></svg>
</div>

<div class="card">
<strong>Anomaly & Alert Log</strong>
<div id="alertLog"></div>
</div>

<div class="card">
<strong>Recent Snapshot History</strong>
<table>
<thead>
<tr>
<th>Time</th>
<th>Rows</th>
<th>Chains</th>
<th>Duration</th>
<th>Anomaly</th>
<th>Delay</th>
<th>Alert</th>
</tr>
</thead>
<tbody id="historyTable"></tbody>
</table>
</div>

</div>

<script>
const SUPABASE_URL = "https://monxcxbrwkjaiwaiosdg.supabase.co";
const ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

async function fetchSnapshots() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/snapshots_meta?select=*&order=snapshot_time.desc&limit=48`,
    {
      headers: {
        apikey: ANON_KEY,
        Authorization: `Bearer ${ANON_KEY}`
      }
    }
  );
  return await res.json();
}

function drawSparkline(svgId, values, color) {
  const svg = document.getElementById(svgId);
  svg.innerHTML = "";
  if (values.length === 0) return;

  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = max - min || 1;

  const width = svg.clientWidth;
  const height = svg.clientHeight;

  const points = values.map((v, i) => {
    const x = (i / (values.length - 1)) * width;
    const y = height - ((v - min) / range) * height;
    return `${x},${y}`;
  }).join(" ");

  const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  polyline.setAttribute("points", points);
  polyline.setAttribute("fill", "none");
  polyline.setAttribute("stroke", color);
  polyline.setAttribute("stroke-width", "2");

  svg.appendChild(polyline);
}

async function loadMonitoring() {
  const data = await fetchSnapshots();
  if (!data || data.length === 0) return;

  const latest = data[0];
  const now = Date.now();
  const snapshotTime = new Date(latest.snapshot_time).getTime();
  const minsAgo = Math.floor((now - snapshotTime) / 60000);

  let healthClass = "good";
  let healthText = "Healthy";

  if (latest.anomaly_flag || latest.delay_flag) {
    healthClass = "bad";
    healthText = "Issue Detected";
  } else if (minsAgo > 75) {
    healthClass = "warn";
    healthText = "Delayed";
  }

  document.getElementById("healthStatus").innerHTML = `
    <div class="${healthClass}">${healthText}</div>
    <div class="small">
      Snapshot: ${latest.snapshot_time}<br/>
      ${minsAgo} minutes ago
    </div>
  `;

  const uptimeCount = data.filter(d => !d.anomaly_flag && !d.delay_flag).length;
  const uptimePercent = ((uptimeCount / data.length) * 100).toFixed(1);

  document.getElementById("slaStats").innerHTML = `
    SLA (last ${data.length} runs): ${uptimePercent}%<br/>
    Rows: ${latest.row_count}<br/>
    Chains: ${latest.chain_count}<br/>
    Duration: ${latest.duration_ms} ms
  `;

  drawSparkline("rowTrend", data.map(d => d.row_count).reverse(), "#22c55e");
  drawSparkline("durationTrend", data.map(d => d.duration_ms).reverse(), "#60a5fa");

  const alertEntries = data.filter(d => d.anomaly_flag || d.delay_flag);
  document.getElementById("alertLog").innerHTML =
    alertEntries.length === 0
      ? "No recent alerts."
      : alertEntries.map(a => `
        <div class="small">
          ${a.snapshot_time} ‚Äî
          ${a.anomaly_flag ? "Anomaly " : ""}
          ${a.delay_flag ? "Delay" : ""}
        </div>
      `).join("");

  const tbody = document.getElementById("historyTable");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${row.snapshot_time}</td>
      <td>${row.row_count}</td>
      <td>${row.chain_count}</td>
      <td>${row.duration_ms} ms</td>
      <td>${row.anomaly_flag ? "‚ö†" : "‚úì"}</td>
      <td>${row.delay_flag ? "‚è≥" : "-"}</td>
      <td>${row.alert_sent_at ? "üì©" : "-"}</td>
    `;

    tbody.appendChild(tr);
  });

  document.getElementById("refreshInfo").innerText =
    "Auto-refresh every 60 seconds";
}

setInterval(loadMonitoring, 60000);
loadMonitoring();
</script>

</body>
</html>
