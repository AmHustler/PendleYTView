<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 18px;
  font-size: 20px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 18px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 14px;
}

.metric {
  background: #0f172a;
  padding: 14px;
  border-radius: 10px;
}

.metric-title {
  font-size: 12px;
  color: #9ca3af;
}

.metric-value {
  font-size: 20px;
  font-weight: 600;
  margin-top: 6px;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

.small { font-size: 12px; color: #9ca3af; }
</style>
</head>

<body>

<header>
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
  <div>
    <div style="font-size:20px;font-weight:600;">Pendle Monitoring</div>
    <div class="small">Auto-refresh every 60 seconds</div>
  </div>
  <div id="statusBanner" style="
      padding:8px 14px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      margin-top:8px;">
    Checking status...
  </div>
</div>
</header>

<div class="section">

<div class="card">
<h3>üìä Ingestion Health</h3>
<div id="ingestionMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üìà Traffic Overview</h3>
<div id="trafficMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üö® Alerts</h3>
<div id="alertMetrics" class="grid"></div>
</div>

  <div class="card">
<h3>üîÆ Predictive Intelligence</h3>
<div id="predictiveMetrics" class="grid"></div>
  </div>

  <div class="card">
<h3>üß† Quant Intelligence</h3>
<div id="quantMetrics" class="grid"></div>
  </div>
  
</div>

<script>

// üîê Password session
let password = sessionStorage.getItem("admin_secret");

if (!password) {
  password = prompt("Enter Admin Password:");
  if (password) sessionStorage.setItem("admin_secret", password);
}

async function fetchMonitor() {
  const res = await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    {
      headers: { "x-admin-secret": password }
    }
  );

  if (!res.ok) {
    sessionStorage.removeItem("admin_secret");
    alert("Authentication failed");
    location.reload();
    return null;
  }

  return await res.json();
}

function metric(title, value, colorClass="") {
  return `
    <div class="metric">
      <div class="metric-title">${title}</div>
      <div class="metric-value ${colorClass}">${value}</div>
    </div>
  `;
}

async function loadMonitoring() {
  const res = await fetchMonitor();
  if (!res) return;

  const { ingestion, traffic, alerts } = res;

  // ===============================
// üîÆ PREDICTIVE INTELLIGENCE ENGINE
// ===============================

const durationsSpread = ingestion.p95_duration_ms - ingestion.avg_duration_ms;
const durationVolatilityScore = durationsSpread / ingestion.avg_duration_ms;

let delayRisk = 0;
let durationRisk = 0;
let anomalyRisk = 0;

// Delay Risk
if (ingestion.minutes_since_latest > 50) delayRisk += 30;
if (ingestion.interval_drift_minutes > 5) delayRisk += 25;
if (ingestion.sla_percent < 98) delayRisk += 20;

// Duration Risk
if (durationVolatilityScore > 0.5) durationRisk += 30;
if (ingestion.max_duration_ms > ingestion.avg_duration_ms * 1.5) durationRisk += 30;
if (ingestion.p95_duration_ms > ingestion.avg_duration_ms * 1.3) durationRisk += 20;

// Row Risk
if (Math.abs(parseFloat(ingestion.row_change_percent)) > 5) anomalyRisk += 30;

// Normalize (0‚Äì100 cap)
delayRisk = Math.min(delayRisk, 100);
durationRisk = Math.min(durationRisk, 100);
anomalyRisk = Math.min(anomalyRisk, 100);

// Confidence Model
let predictiveConfidence = 100 - (
  (delayRisk * 0.4) +
  (durationRisk * 0.3) +
  (anomalyRisk * 0.3)
);

if (predictiveConfidence < 0) predictiveConfidence = 0;

  // ===============================
// üìà DURATION PREDICTION ENGINE
// ===============================

const avg = ingestion.avg_duration_ms;
const p95 = ingestion.p95_duration_ms;
const max = ingestion.max_duration_ms;
const latestDuration = ingestion.duration_ms;

// Volatility factor
const volatility = (p95 - avg) / avg;

// Weighted bias toward latest
let predictedDuration =
  (latestDuration * 0.4) +
  (avg * 0.4) +
  (p95 * 0.2);

// Stress penalty if volatility high
if (volatility > 0.4) {
  predictedDuration *= 1.15;
}

// Cap to reasonable bounds
if (predictedDuration < avg * 0.8)
  predictedDuration = avg * 0.8;

if (predictedDuration > max * 1.1)
  predictedDuration = max * 1.1;

predictedDuration = Math.round(predictedDuration);

  // ===============================
// üßÆ QUANT ANOMALY ENGINE
// ===============================

// Approximate standard deviation
const approxStdDev = (p95 - avg) / 1.645; // normal distribution approx

let zScore = 0;
if (approxStdDev > 0) {
  zScore = (latestDuration - avg) / approxStdDev;
}

let anomalyIntensity = Math.abs(zScore) * 20; // scaled model
if (anomalyIntensity > 100) anomalyIntensity = 100;

let anomalyLevel = "Stable";
if (anomalyIntensity > 40) anomalyLevel = "Elevated";
if (anomalyIntensity > 70) anomalyLevel = "Critical";

  // ===============================
// üü¢ STATUS BANNER + NEXT SNAPSHOT
// ===============================

const mins = ingestion.minutes_since_latest;
const expectedInterval = 60;
const minsToNext = expectedInterval - mins;

let banner = document.getElementById("statusBanner");

if (mins <= 60) {
  banner.style.background = "#052e16";
  banner.style.color = "#22c55e";
  banner.innerHTML = `üü¢ Healthy ‚Äî Next snapshot in ~${minsToNext} min`;
}
else if (mins <= 75) {
  banner.style.background = "#422006";
  banner.style.color = "#f59e0b";
  banner.innerHTML = `üü° Delayed ‚Äî Snapshot overdue by ${mins - 60} min`;
}
else {
  banner.style.background = "#3f0f12";
  banner.style.color = "#ef4444";
  banner.innerHTML = `üî¥ Critical ‚Äî No snapshot for ${mins} min`;
}

  // ===============================
  // INGESTION
  // ===============================

  let healthColor = "good";
  if (ingestion.health_score < 90) healthColor = "warn";
  if (ingestion.health_score < 70) healthColor = "bad";

  document.getElementById("ingestionMetrics").innerHTML =
    metric("Health Score", ingestion.health_score + "/100", healthColor) +
    metric("Rows", ingestion.row_count) +
    metric("Chains", ingestion.chain_count) +
    metric("Minutes Since Snapshot", ingestion.minutes_since_latest) +
    metric("Row Œî %", ingestion.row_change_percent + "%") +
    metric("Interval Drift", ingestion.interval_drift_minutes + "m") +
    metric("SLA", ingestion.sla_percent + "%") +
    metric("Avg Duration", ingestion.avg_duration_ms + " ms") +
    metric("P95 Duration", ingestion.p95_duration_ms + " ms") +
    metric("Max Duration", ingestion.max_duration_ms + " ms");

  // ===============================
  // TRAFFIC
  // ===============================

  document.getElementById("trafficMetrics").innerHTML =
    metric("Today Visits", traffic.today_total) +
    metric("Today Unique", traffic.today_unique) +
    metric("Yesterday Visits", traffic.yesterday_total) +
    metric("Yesterday Unique", traffic.yesterday_unique) +
    metric("Growth %", traffic.growth_percent + "%") +
    metric("30d Total", traffic.total_30_days) +
    metric("30d Unique", traffic.unique_30_days);

  // ===============================
  // ALERTS
  // ===============================

  document.getElementById("alertMetrics").innerHTML =
    metric("Alerts (Last 48 Runs)", alerts.total_last_48_runs) +
    metric("Last Alert", alerts.last_alert_time || "None");

  document.getElementById("predictiveMetrics").innerHTML = `
  ${metric("Delay Risk", delayRisk + "%", delayRisk > 60 ? "bad" : delayRisk > 40 ? "warn" : "good")}
  ${metric("Duration Spike Risk", durationRisk + "%", durationRisk > 60 ? "bad" : durationRisk > 40 ? "warn" : "good")}
  ${metric("Row Instability Risk", anomalyRisk + "%", anomalyRisk > 60 ? "bad" : anomalyRisk > 40 ? "warn" : "good")}
  ${metric("Predictive Confidence", Math.round(predictiveConfidence) + "%", predictiveConfidence > 70 ? "good" : predictiveConfidence > 50 ? "warn" : "bad")}
`;

  document.getElementById("quantMetrics").innerHTML = `
  ${metric("Predicted Next Duration", predictedDuration + " ms")}
  ${metric("Z-Score", zScore.toFixed(2))}
  ${metric("Anomaly Intensity", Math.round(anomalyIntensity) + "%", anomalyIntensity > 70 ? "bad" : anomalyIntensity > 40 ? "warn" : "good")}
  ${metric("Anomaly Level", anomalyLevel, anomalyIntensity > 70 ? "bad" : anomalyIntensity > 40 ? "warn" : "good")}
`;
}

loadMonitoring();
setInterval(loadMonitoring, 60000);

</script>

</body>
</html>
