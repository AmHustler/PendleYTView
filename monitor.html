<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pendle Sovereign Control Surface</title>

<style>

/* =====================================
   SOVEREIGN THEME ENGINE
===================================== */

:root {
  --bg: #0a0f1c;
  --card: rgba(18,24,40,0.75);
  --border: rgba(255,255,255,0.06);
  --text: #e6edf3;
  --muted: #8b98b8;
  --green: #22c55e;
  --amber: #f59e0b;
  --red: #ef4444;
  --purple: #8b5cf6;
  --cyan: #06b6d4;
}

body {
  margin:0;
  background: radial-gradient(circle at 50% -10%, #131c33 0%, #0a0f1c 70%);
  font-family: "Inter", system-ui, sans-serif;
  color:var(--text);
  letter-spacing:0.3px;
}

/* =====================================
   HEADER
===================================== */

header {
  padding:28px 40px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title {
  font-size:24px;
  font-weight:600;
}

.subtitle {
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

#statusBanner {
  padding:10px 20px;
  border-radius:8px;
  font-weight:600;
  font-size:13px;
  transition:0.4s ease;
}

/* =====================================
   LAYOUT
===================================== */

.wrapper {
  padding:36px;
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(520px,1fr));
  gap:30px;
}

/* =====================================
   CARD
===================================== */

.card {
  background:var(--card);
  backdrop-filter: blur(14px);
  border-radius:18px;
  padding:24px;
  border:1px solid var(--border);
  position:relative;
  overflow:hidden;
}

.card h3 {
  font-size:13px;
  letter-spacing:1px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:22px;
}

/* =====================================
   STABILITY INDEX
===================================== */

.index-panel {
  text-align:center;
  padding:24px;
  border-radius:14px;
  margin-bottom:22px;
  background:rgba(139,92,246,0.08);
  border:1px solid rgba(139,92,246,0.25);
}

.index-score {
  font-size:40px;
  font-weight:700;
}

.small { font-size:12px; color:var(--muted); }

/* =====================================
   GAUGE
===================================== */

.gauge svg { width:140px; height:140px; }

.gauge-container {
  display:flex;
  align-items:center;
  gap:30px;
}

/* =====================================
   GRID
===================================== */

.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap:18px;
}

.metric {
  background:rgba(15,22,40,0.7);
  padding:16px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.04);
}

.metric-title {
  font-size:11px;
  text-transform:uppercase;
  color:var(--muted);
}

.metric-value {
  font-size:18px;
  margin-top:6px;
  font-weight:600;
}

/* =====================================
   PROGRESS BAR
===================================== */

.progress {
  height:6px;
  background:rgba(255,255,255,0.05);
  border-radius:4px;
  margin-top:8px;
  overflow:hidden;
}

.progress-fill {
  height:100%;
  transition:0.5s ease;
}

/* =====================================
   RADAR
===================================== */

.radar svg {
  width:260px;
  height:260px;
}

/* =====================================
   SPARKLINE
===================================== */

.sparkline svg {
  width:100%;
  height:60px;
}

</style>
</head>

<body>

<header>
  <div>
    <div class="title">Pendle Sovereign Control Surface</div>
    <div class="subtitle">Autonomous Quant Risk Intelligence Layer</div>
  </div>
  <div id="statusBanner">Initializing...</div>
</header>

<div class="wrapper">

  <div class="card">
    <h3>System Stability</h3>
    <div id="stabilityIndex"></div>
    <div id="healthGauge" class="gauge-container"></div>
  </div>

  <div class="card">
    <h3>Operational Matrix</h3>
    <div id="opsGrid" class="grid"></div>
  </div>

  <div class="card">
    <h3>Risk Radar</h3>
    <div id="riskRadar" class="radar"></div>
  </div>

  <div class="card">
    <h3>Trend Momentum</h3>
    <div id="trendSparkline" class="sparkline"></div>
  </div>

  <div class="card">
    <h3>AI Executive Summary</h3>
    <div id="aiNarrative"></div>
  </div>

</div>

<script>

/* =====================================
   AUTH
===================================== */

let password = sessionStorage.getItem("admin_secret");
if (!password) {
  password = prompt("Enter Admin Password:");
  if (password) sessionStorage.setItem("admin_secret", password);
}

async function fetchMonitor(){
  const res = await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    { headers: { "x-admin-secret": password } }
  );
  if(!res.ok){
    sessionStorage.removeItem("admin_secret");
    location.reload();
    return null;
  }
  return await res.json();
}

/* =====================================
   GAUGE
===================================== */

function renderGauge(score){
  const r=55;
  const c=2*Math.PI*r;
  const offset=c-(score/100)*c;
  const color=score>80?"#22c55e":score>60?"#f59e0b":"#ef4444";

  return `
  <div class="gauge">
  <svg>
    <circle cx="70" cy="70" r="${r}" stroke="rgba(255,255,255,0.05)" stroke-width="10" fill="none"/>
    <circle cx="70" cy="70" r="${r}" stroke="${color}" stroke-width="10" fill="none"
      stroke-dasharray="${c}" stroke-dashoffset="${offset}"
      stroke-linecap="round"
      transform="rotate(-90 70 70)"/>
  </svg>
  </div>
  <div>
    <div style="font-size:34px;font-weight:700;color:${color}">
      ${score}/100
    </div>
    <div class="small">Composite Stability</div>
  </div>`;
}

/* =====================================
   RADAR POLYGON
===================================== */

function renderRadar(values){
  const size=260;
  const center=130;
  const radius=100;
  const axes=values.length;
  let points="";

  values.forEach((v,i)=>{
    const angle=(Math.PI*2/axes)*i - Math.PI/2;
    const r=(v/100)*radius;
    const x=center + r*Math.cos(angle);
    const y=center + r*Math.sin(angle);
    points+=`${x},${y} `;
  });

  return `
  <svg>
    <polygon points="${points}"
      fill="rgba(139,92,246,0.4)"
      stroke="#8b5cf6"
      stroke-width="2"/>
  </svg>`;
}

/* =====================================
   SPARKLINE
===================================== */

function renderSparkline(values){
  const width=500;
  const height=60;
  const max=Math.max(...values);
  const min=Math.min(...values);
  const range=max-min || 1;

  const points=values.map((v,i)=>{
    const x=(i/(values.length-1))*width;
    const y=height - ((v-min)/range)*height;
    return `${x},${y}`;
  }).join(" ");

  return `
  <svg viewBox="0 0 ${width} ${height}">
    <polyline points="${points}"
      fill="none"
      stroke="#06b6d4"
      stroke-width="2"/>
  </svg>`;
}

/* =====================================
   MAIN
===================================== */

async function load(){
  const res=await fetchMonitor();
  if(!res) return;

  const { ingestion }=res;

  const avg=ingestion.avg_duration_ms;
  const p95=ingestion.p95_duration_ms;
  const latest=ingestion.duration_ms;
  const drift=parseFloat(ingestion.interval_drift_minutes);
  const mins=ingestion.minutes_since_latest;

  const volatility=(p95-avg)/avg;
  const approxStd=(p95-avg)/1.645;
  const z=approxStd>0?(latest-avg)/approxStd:0;
  const anomaly=Math.min(Math.abs(z)*20,100);

  const delayRisk=Math.min(
    (mins>50?25:0)+(drift>5?20:0)+(volatility>0.4?20:0),100);

  const composite=Math.round(
    ingestion.health_score*0.5+
    (100-delayRisk)*0.3+
    (100-anomaly)*0.2);

  /* Banner */
  const banner=document.getElementById("statusBanner");
  if(mins<=60){
    banner.style.background="#052e16";
    banner.style.color="#22c55e";
    banner.innerHTML="SYSTEM STABLE";
  } else {
    banner.style.background="#3f0f12";
    banner.style.color="#ef4444";
    banner.innerHTML="SYSTEM DEGRADED";
  }

  /* Stability */
  document.getElementById("stabilityIndex").innerHTML=
    `<div class="index-panel">
      <div class="index-score">${composite}</div>
      <div class="small">Institutional Stability Index</div>
     </div>`;

  document.getElementById("healthGauge").innerHTML=
    renderGauge(ingestion.health_score);

  /* Ops */
  document.getElementById("opsGrid").innerHTML=
    metric("SLA %",ingestion.sla_percent)+
    metric("Row Î” %",ingestion.row_change_percent)+
    metric("Drift",ingestion.interval_drift_minutes+"m")+
    metric("Avg",avg+" ms")+
    metric("P95",p95+" ms");

  /* Radar */
  document.getElementById("riskRadar").innerHTML=
    renderRadar([delayRisk, anomaly, volatility*100, ingestion.health_score]);

  /* Sparkline */
  document.getElementById("trendSparkline").innerHTML=
    renderSparkline([
      avg*0.9,
      avg,
      latest,
      p95,
      avg*1.1
    ]);

  /* AI Narrative */
  document.getElementById("aiNarrative").innerHTML=
    `<div class="small">
      Stability index ${composite}. 
      Delay risk ${delayRisk}%. 
      Anomaly intensity ${Math.round(anomaly)}%. 
      Volatility regime ${volatility>0.6?"High":volatility>0.3?"Moderate":"Low"}.
    </div>`;
}

function metric(title,value){
  return `<div class="metric">
            <div class="metric-title">${title}</div>
            <div class="metric-value">${value}</div>
          </div>`;
}

load();
setInterval(load,60000);

</script>

</body>
</html>
