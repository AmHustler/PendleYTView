<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 18px;
  font-size: 20px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 18px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 14px;
}

.metric {
  background: #0f172a;
  padding: 14px;
  border-radius: 10px;
}

.metric-title {
  font-size: 12px;
  color: #9ca3af;
}

.metric-value {
  font-size: 20px;
  font-weight: 600;
  margin-top: 6px;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

.small { font-size: 12px; color: #9ca3af; }
</style>
</head>

<body>

<header>
Pendle Monitoring
<div class="small">Auto-refresh every 60 seconds</div>
</header>

<div class="section">

<div class="card">
<h3>üìä Ingestion Health</h3>
<div id="ingestionMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üìà Traffic Overview</h3>
<div id="trafficMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üö® Alerts</h3>
<div id="alertMetrics" class="grid"></div>
</div>

</div>

<script>

// üîê Password session
let password = sessionStorage.getItem("admin_secret");

if (!password) {
  password = prompt("Enter Admin Password:");
  if (password) sessionStorage.setItem("admin_secret", password);
}

async function fetchMonitor() {
  const res = await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    {
      headers: { "x-admin-secret": password }
    }
  );

  if (!res.ok) {
    sessionStorage.removeItem("admin_secret");
    alert("Authentication failed");
    location.reload();
    return null;
  }

  return await res.json();
}

function metric(title, value, colorClass="") {
  return `
    <div class="metric">
      <div class="metric-title">${title}</div>
      <div class="metric-value ${colorClass}">${value}</div>
    </div>
  `;
}

async function loadMonitoring() {
  const res = await fetchSnapshots();
  if (!res) return;

  const { ingestion, traffic, alerts } = res;

  // ===============================
  // üß† HEALTH GRADE
  // ===============================

  const score = ingestion.health_score;
  let grade = "A";
  let color = "#22c55e";

  if (score < 90) { grade = "B"; color = "#f59e0b"; }
  if (score < 75) { grade = "C"; color = "#fb923c"; }
  if (score < 60) { grade = "D"; color = "#ef4444"; }

  document.getElementById("healthStatus").innerHTML = `
    <div style="font-size:28px;font-weight:700;color:${color}">
      ${score} / 100
    </div>
    <div class="small">Grade: ${grade}</div>
    <div class="small">
      ${ingestion.minutes_since_latest} mins since last snapshot
    </div>
  `;

  // ===============================
  // üìä INGESTION METRICS GRID
  // ===============================

  document.getElementById("slaStats").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">

      <div>Rows<br/><strong>${ingestion.row_count}</strong></div>
      <div>Chains<br/><strong>${ingestion.chain_count}</strong></div>

      <div>Row Œî %<br/><strong>${ingestion.row_change_percent}%</strong></div>
      <div>Interval Drift<br/><strong>${ingestion.interval_drift_minutes}m</strong></div>

      <div>SLA<br/><strong>${ingestion.sla_percent}%</strong></div>
      <div>Total Runs<br/><strong>${ingestion.total_runs}</strong></div>

      <div>Avg Duration<br/><strong>${ingestion.avg_duration_ms} ms</strong></div>
      <div>P95 Duration<br/><strong>${ingestion.p95_duration_ms} ms</strong></div>

      <div>Max Duration<br/><strong>${ingestion.max_duration_ms} ms</strong></div>

    </div>
  `;

  // ===============================
  // üìà TRAFFIC METRICS GRID
  // ===============================

  document.getElementById("alertLog").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">

      <div>Today Visits<br/><strong>${traffic.today_total}</strong></div>
      <div>Today Unique<br/><strong>${traffic.today_unique}</strong></div>

      <div>Yesterday Visits<br/><strong>${traffic.yesterday_total}</strong></div>
      <div>Yesterday Unique<br/><strong>${traffic.yesterday_unique}</strong></div>

      <div>Growth %<br/><strong>${traffic.growth_percent}%</strong></div>
      <div>30d Total<br/><strong>${traffic.total_30_days}</strong></div>

      <div>30d Unique<br/><strong>${traffic.unique_30_days}</strong></div>

    </div>
    <hr style="margin:14px 0;border-color:#1f2937"/>
    <div>
      Alerts (48 runs): <strong>${alerts.total_last_48_runs}</strong><br/>
      Last Alert: <strong>${alerts.last_alert_time || "None"}</strong>
    </div>
  `;
}
load();
setInterval(load, 60000);

</script>

</body>
</html>
