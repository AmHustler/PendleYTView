<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pendle Sovereign Control Surface</title>

<style>
:root{
  --bg:#0b1220;
  --card:rgba(18,24,40,0.75);
  --border:rgba(255,255,255,0.06);
  --text:#e6edf3;
  --muted:#8b98b8;
  --green:#22c55e;
  --amber:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --cyan:#06b6d4;
}

body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:radial-gradient(circle at 50% -10%, #1b2440 0%, #0b1220 70%);
  color:var(--text);
}

header{
  padding:28px 40px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{font-size:22px;font-weight:600;}
.subtitle{font-size:12px;color:var(--muted);}

#statusBanner{
  padding:10px 18px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
}

#executiveStrip{
  padding:14px 40px;
  border-bottom:1px solid var(--border);
  font-size:13px;
  color:var(--muted);
}

.wrapper{
  padding:32px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(480px,1fr));
  gap:28px;
}

.card{
  background:var(--card);
  backdrop-filter:blur(14px);
  border-radius:16px;
  padding:22px;
  border:1px solid var(--border);
}

.card h3{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--muted);
  margin-bottom:18px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
}

  .radar {
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px 0;
  }

.metric{
  background:rgba(15,22,40,0.7);
  padding:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
}

.metric-title{
  font-size:10px;
  text-transform:uppercase;
  color:var(--muted);
}

.metric-value{
  font-size:16px;
  font-weight:600;
  margin-top:4px;
}

.small{font-size:12px;color:var(--muted);}

.progress{
  height:5px;
  background:rgba(255,255,255,0.06);
  border-radius:4px;
  margin-top:6px;
}

.progress-fill{
  height:100%;
  border-radius:4px;
}

.gauge svg{width:130px;height:130px;}

.radar svg{
  width:100%;
  max-width:360px;
  height:auto;
}

.sparkline svg{width:100%;height:60px;}

.index-panel{
  text-align:center;
  padding:20px;
  border-radius:12px;
  margin-bottom:18px;
  background:rgba(139,92,246,0.08);
  border:1px solid rgba(139,92,246,0.3);
}

.index-score{font-size:36px;font-weight:700;}
</style>
</head>

<body>

<header>
  <div>
    <div class="title">Pendle Sovereign Control Surface</div>
    <div class="subtitle">Autonomous Quant Risk Intelligence Layer</div>
  </div>
  <div id="statusBanner">Initializing...</div>
</header>

<div id="executiveStrip"></div>

<div class="wrapper">

<div class="card">
  <h3>System Stability</h3>
  <div id="stabilityIndex"></div>
  <div id="healthGauge"></div>
</div>

<div class="card">
  <h3>Operational Matrix</h3>
  <div id="opsGrid" class="grid"></div>
</div>

<div class="card">
  <h3>Risk Radar</h3>
  <div id="riskRadar" class="radar"></div>
</div>

<div class="card">
  <h3>Trend Momentum</h3>
  <div id="trendSparkline" class="sparkline"></div>
</div>

<div class="card">
  <h3>AI Executive Summary</h3>
  <div id="aiNarrative"></div>
</div>

<div class="card">
  <h3>Autonomous Intelligence Layer</h3>
  <div id="autonomyPanel"></div>
</div>

</div>

<script>
/* ================= AUTH ================= */
let password=sessionStorage.getItem("admin_secret");
if(!password){
  password=prompt("Enter Admin Password:");
  if(password) sessionStorage.setItem("admin_secret",password);
}

async function fetchMonitor(){
  const res=await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    {headers:{"x-admin-secret":password}}
  );
  if(!res.ok){
    sessionStorage.removeItem("admin_secret");
    location.reload();
    return null;
  }
  return await res.json();
}

/* ================= UTILITIES ================= */

function metric(title,value,bar=null,color="#22c55e"){
  return `
  <div class="metric">
    <div class="metric-title">${title}</div>
    <div class="metric-value">${value}</div>
    ${bar?`
      <div class="progress">
        <div class="progress-fill" 
          style="width:${bar}%;background:${color}">
        </div>
      </div>`:""}
  </div>`;
}

function renderGauge(core,adaptive){
  const r=50;
  const c=2*Math.PI*r;

  function ring(score,color,width){
    const offset=c-(score/100)*c;
    return `
      <circle cx="65" cy="65" r="${r}"
        stroke="${color}"
        stroke-width="${width}"
        fill="none"
        stroke-dasharray="${c}"
        stroke-dashoffset="${offset}"
        stroke-linecap="round"
        transform="rotate(-90 65 65)"/>`;
  }

  return `
  <svg>
    <circle cx="65" cy="65" r="${r}"
      stroke="rgba(255,255,255,0.06)"
      stroke-width="6"
      fill="none"/>
    ${ring(core,"#22c55e",6)}
    ${ring(adaptive,"#8b5cf6",3)}
  </svg>
  <div>
    <div style="font-size:28px;font-weight:700">${core}</div>
    <div class="small">Adaptive ${adaptive}</div>
  </div>`;
}

function renderRadar(values){

  const size = 360;
  const center = size / 2;
  const radius = 110;
  const axes = values.length;

  const labels = ["Delay","Anomaly","Volatility","Health"];

  let polygonPoints = "";
  let axisLines = "";
  let labelSVG = "";
  let gridSVG = "";
  let pointDots = "";
  let valueLabels = "";

  // Grid rings
  for(let r = 1; r <= 4; r++){
    const ring = (r/4) * radius;
    gridSVG += `
      <circle cx="${center}" cy="${center}"
        r="${ring}"
        fill="none"
        stroke="rgba(255,255,255,0.06)"
        stroke-width="1"/>`;
  }

  values.forEach((v,i)=>{
    const angle = (Math.PI*2/axes)*i - Math.PI/2;
    const scaled = (v/100)*radius;

    const x = center + scaled*Math.cos(angle);
    const y = center + scaled*Math.sin(angle);

    polygonPoints += `${x},${y} `;

    // Axis line
    const ax = center + radius*Math.cos(angle);
    const ay = center + radius*Math.sin(angle);

    axisLines += `
      <line x1="${center}" y1="${center}"
            x2="${ax}" y2="${ay}"
            stroke="rgba(255,255,255,0.08)"
            stroke-width="1"/>`;

    // Axis label
    const lx = center + (radius + 30)*Math.cos(angle);
    const ly = center + (radius + 30)*Math.sin(angle);

    let anchor = "middle";
    if(Math.cos(angle) > 0.3) anchor = "start";
    if(Math.cos(angle) < -0.3) anchor = "end";

    labelSVG += `
      <text x="${lx}" y="${ly}"
        font-size="12"
        fill="#8b98b8"
        text-anchor="${anchor}"
        dominant-baseline="middle">
        ${labels[i]}
      </text>`;

    // Data point dot
    pointDots += `
      <circle cx="${x}" cy="${y}"
        r="4"
        fill="#8b5cf6"
        stroke="#ffffff"
        stroke-width="1"/>`;

    // Value label next to dot
    const vx = center + (scaled + 14)*Math.cos(angle);
    const vy = center + (scaled + 14)*Math.sin(angle);

    valueLabels += `
      <text x="${vx}" y="${vy}"
        font-size="11"
        fill="#e6edf3"
        text-anchor="middle"
        dominant-baseline="middle">
        ${Math.round(v)}
      </text>`;
  });

  return `
  <div style="display:flex;justify-content:center;">
  <svg width="${size}" height="${size}">
    ${gridSVG}
    ${axisLines}
    <polygon points="${polygonPoints}"
      fill="rgba(139,92,246,0.25)"
      stroke="#8b5cf6"
      stroke-width="2"/>
    ${pointDots}
    ${valueLabels}
    ${labelSVG}
  </svg>
  </div>`;
}

function renderSparkline(values){

  if(values.length < 3) return "<div class='small'>Collecting data...</div>";

  const width = 500;
  const height = 70;

  // EWMA smoothing
  const alpha = 0.4;
  let ewma = values[0];
  let smooth = [];

  for(let i=0;i<values.length;i++){
    ewma = alpha*values[i] + (1-alpha)*ewma;
    smooth.push(ewma);
  }

  const max = Math.max(...smooth);
  const min = Math.min(...smooth);
  const range = max-min || 1;

  const points = smooth.map((v,i)=>{
    const x = (i/(smooth.length-1))*width;
    const y = height - ((v-min)/range)*height;
    return `${x},${y}`;
  }).join(" ");

  const areaPoints = `0,${height} ${points} ${width},${height}`;

  // Momentum detection
  const momentum = smooth[smooth.length-1] - smooth[smooth.length-3];

  let color = "#06b6d4";
  let label = "Flat";

  if(momentum > 2){ color="#22c55e"; label="Uptrend"; }
  if(momentum < -2){ color="#ef4444"; label="Downtrend"; }

  return `
  <div style="margin-bottom:8px;font-size:12px;color:#8b98b8">
    Trend: ${label}
  </div>
  <svg viewBox="0 0 ${width} ${height}">
    <polygon points="${areaPoints}"
      fill="${color}"
      opacity="0.1"/>
    <polyline points="${points}"
      fill="none"
      stroke="${color}"
      stroke-width="2"/>
  </svg>`;
}

/* ================= MAIN ================= */

async function load(){
  const res=await fetchMonitor();
  if(!res) return;

  const {ingestion}=res;

  const avg=ingestion.avg_duration_ms;
  const p95=ingestion.p95_duration_ms;
  const latest=ingestion.duration_ms;
  const drift=parseFloat(ingestion.interval_drift_minutes);
  const mins=ingestion.minutes_since_latest;

  const volatility=(p95-avg)/avg;
  const approxStd=(p95-avg)/1.645;
  const z=approxStd>0?(latest-avg)/approxStd:0;
  const anomaly=Math.min(Math.abs(z)*20,100);
  const delayRisk=Math.min((mins>50?25:0)+(drift>5?20:0)+(volatility>0.4?20:0),100);

  const composite=Math.round(
    ingestion.health_score*0.5+
    (100-delayRisk)*0.3+
    (100-anomaly)*0.2
  );

  /* Memory */
  function push(key,val){
    let arr=JSON.parse(localStorage.getItem(key)||"[]");
    arr.push(val);
    if(arr.length>20) arr.shift();
    localStorage.setItem(key,JSON.stringify(arr));
  }

  push("stability",composite);
  const stabilityHist=JSON.parse(localStorage.getItem("stability"));

  /* Banner */
  const banner=document.getElementById("statusBanner");
  if(mins<=60){
    banner.style.background="#052e16";
    banner.style.color="#22c55e";
    banner.innerHTML="SYSTEM STABLE";
  } else {
    banner.style.background="#3f0f12";
    banner.style.color="#ef4444";
    banner.innerHTML="SYSTEM DEGRADED";
  }

  /* Executive */
  document.getElementById("executiveStrip").innerHTML=
    `Stability ${composite} | Delay ${delayRisk}% | Anomaly ${Math.round(anomaly)}%`;

  /* Stability */
  document.getElementById("stabilityIndex").innerHTML=
    `<div class="index-panel">
      <div class="index-score">${composite}</div>
      <div class="small">Institutional Stability Index</div>
     </div>`;

  document.getElementById("healthGauge").innerHTML=
    renderGauge(ingestion.health_score,composite);

  /* Ops */
  document.getElementById("opsGrid").innerHTML=
    metric("SLA",ingestion.sla_percent+"%")+
    metric("Delay Risk",delayRisk+"%",delayRisk,"#ef4444")+
    metric("Anomaly",Math.round(anomaly)+"%",anomaly,"#f59e0b")+
    metric("Volatility",Math.round(volatility*100)+"%",volatility*100,"#8b5cf6")+
    metric("Avg",avg+" ms")+
    metric("P95",p95+" ms");

  /* Radar */
  document.getElementById("riskRadar").innerHTML=
    renderRadar([delayRisk,anomaly,volatility*100,ingestion.health_score]);

  /* Trend */
  document.getElementById("trendSparkline").innerHTML=
    renderSparkline(stabilityHist);
  
  /* AI Narrative */
  document.getElementById("aiNarrative").innerHTML=
    `<div class="small">
      Composite stability ${composite}. 
      Delay risk ${delayRisk}%. 
      Anomaly intensity ${Math.round(anomaly)}%.
      Volatility regime ${volatility>0.6?"High":volatility>0.3?"Moderate":"Low"}.
    </div>`;

  /* Autonomy */
  document.getElementById("autonomyPanel").innerHTML=
    `<div class="grid">
      ${metric("Composite",composite)}
      ${metric("Z-Score",z.toFixed(2))}
      ${metric("Drift",drift+"m")}
      ${metric("Minutes Since",mins)}
    </div>`;
}

load();
setInterval(load,60000);
</script>

</body>
</html>
