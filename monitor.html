<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendle Monitoring</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b0e14;
  color: #e6e6e6;
}

header {
  padding: 18px;
  font-size: 20px;
  font-weight: 600;
  border-bottom: 1px solid #1f2937;
}

.section {
  padding: 18px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 14px;
}

.metric {
  background: #0f172a;
  padding: 14px;
  border-radius: 10px;
}

.metric-title {
  font-size: 12px;
  color: #9ca3af;
}

.metric-value {
  font-size: 20px;
  font-weight: 600;
  margin-top: 6px;
}

.good { color: #22c55e; }
.warn { color: #f59e0b; }
.bad { color: #ef4444; }

.small { font-size: 12px; color: #9ca3af; }
</style>
</head>

<body>

<header>
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
  <div>
    <div style="font-size:20px;font-weight:600;">Pendle Monitoring</div>
    <div class="small">Auto-refresh every 60 seconds</div>
  </div>
  <div id="statusBanner" style="
      padding:8px 14px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      margin-top:8px;">
    Checking status...
  </div>
</div>
</header>

<div class="section">

<div class="card">
<h3>üìä Ingestion Health</h3>
<div id="ingestionMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üìà Traffic Overview</h3>
<div id="trafficMetrics" class="grid"></div>
</div>

<div class="card">
<h3>üö® Alerts</h3>
<div id="alertMetrics" class="grid"></div>
</div>

  <div class="card">
<h3>üîÆ Predictive Intelligence</h3>
<div id="predictiveMetrics" class="grid"></div>
  </div>

  <div class="card">
<h3>üß† Quant Intelligence</h3>
<div id="quantMetrics" class="grid"></div>
  </div>

  <div class="card">
  <h3>üé≤ Probabilistic Modeling</h3>
  <div id="probabilityMetrics" class="grid"></div>
  </div>
  
</div>

<script>

// ===============================
// üîê AUTH SESSION
// ===============================

let password = sessionStorage.getItem("admin_secret");

if (!password) {
  password = prompt("Enter Admin Password:");
  if (password) sessionStorage.setItem("admin_secret", password);
}

async function fetchMonitor() {
  const res = await fetch(
    "https://pendle-worker.haripavanveera.workers.dev/monitor",
    { headers: { "x-admin-secret": password } }
  );

  if (!res.ok) {
    sessionStorage.removeItem("admin_secret");
    alert("Authentication failed");
    location.reload();
    return null;
  }

  return await res.json();
}

function metric(title, value, colorClass="") {
  return `
    <div class="metric">
      <div class="metric-title">${title}</div>
      <div class="metric-value ${colorClass}">${value}</div>
    </div>
  `;
}

// ===============================
// üöÄ MAIN LOAD
// ===============================

async function loadMonitoring() {

  const res = await fetchMonitor();
  if (!res) return;

  const { ingestion, traffic, alerts } = res;

  // ===============================
  // üìä CORE VARIABLES
  // ===============================

  const avg = ingestion.avg_duration_ms;
  const p95 = ingestion.p95_duration_ms;
  const max = ingestion.max_duration_ms;
  const latest = ingestion.duration_ms;

  const rowDelta = parseFloat(ingestion.row_change_percent);
  const drift = parseFloat(ingestion.interval_drift_minutes);
  const mins = ingestion.minutes_since_latest;

  const volatility = (p95 - avg) / avg;

  // ===============================
  // üß† VOLATILITY REGIME
  // ===============================

  let volatilityRegime = "Low";
  if (volatility > 0.3) volatilityRegime = "Moderate";
  if (volatility > 0.6) volatilityRegime = "High";

  // ===============================
  // üîÆ PREDICTIVE DELAY MODEL
  // ===============================

  let delayRisk = 0;

  if (mins > 50) delayRisk += 25;
  if (drift > 5) delayRisk += 20;
  if (ingestion.sla_percent < 98) delayRisk += 20;
  if (volatility > 0.4) delayRisk += 15;
  if (Math.abs(rowDelta) > 5) delayRisk += 20;

  delayRisk = Math.min(delayRisk, 100);

  // ===============================
  // üìà PREDICT NEXT DURATION
  // ===============================

  let predictedDuration =
    (latest * 0.4) +
    (avg * 0.4) +
    (p95 * 0.2);

  if (volatility > 0.4) predictedDuration *= 1.15;

  predictedDuration = Math.min(
    Math.max(predictedDuration, avg * 0.8),
    max * 1.1
  );

  predictedDuration = Math.round(predictedDuration);

  // ===============================
// üé≤ MONTE CARLO DELAY SIMULATION
// ===============================

function randomNormal(mean, stdDev) {
  let u = 0, v = 0;
  while(u === 0) u = Math.random();
  while(v === 0) v = Math.random();
  return mean + stdDev * Math.sqrt(-2.0 * Math.log(u)) *
         Math.cos(2.0 * Math.PI * v);
}

let delaySimulations = 300;
let delayFailures = 0;

for (let i = 0; i < delaySimulations; i++) {
  const simulatedDuration = randomNormal(avg, (p95 - avg) / 1.645);

  // assume ingestion becomes unstable if duration spikes heavily
  if (simulatedDuration > avg * 1.6) {
    delayFailures++;
  }
}

let monteCarloDelayProbability =
  Math.round((delayFailures / delaySimulations) * 100);

  // ===============================
// üìâ EWMA TREND ENGINE
// ===============================

const alpha = 0.3; // smoothing factor

// Synthetic short memory model
let ewma = avg;

ewma = alpha * latest + (1 - alpha) * ewma;

let ewmaTrend = "Flat";

if (ewma > avg * 1.05) ewmaTrend = "Uptrend";
if (ewma < avg * 0.95) ewmaTrend = "Downtrend";

  // ===============================
// üöÄ DRIFT ACCELERATION DETECTOR
// ===============================

let driftAcceleration = 0;

if (drift > 0) {
  driftAcceleration = drift * volatility;
}

let accelerationLevel = "Normal";

if (driftAcceleration > 5) accelerationLevel = "Elevating";
if (driftAcceleration > 10) accelerationLevel = "Accelerating";

  // ===============================
  // üßÆ Z-SCORE ANOMALY ENGINE
  // ===============================

  const approxStdDev = (p95 - avg) / 1.645;

  let zScore = 0;
  if (approxStdDev > 0) {
    zScore = (latest - avg) / approxStdDev;
  }

  let anomalyIntensity = Math.min(Math.abs(zScore) * 20, 100);

  let anomalyLevel = "Stable";
  if (anomalyIntensity > 40) anomalyLevel = "Elevated";
  if (anomalyIntensity > 70) anomalyLevel = "Critical";

  // ===============================
  // üìâ HEALTH MOMENTUM MODEL
  // ===============================

  let momentum = 0;

  if (latest > avg) momentum -= 10;
  if (rowDelta < 0) momentum -= 10;
  if (drift > 0) momentum -= 15;
  if (volatility > 0.5) momentum -= 20;

  momentum = 100 + momentum;

  let momentumLabel = "Improving";
  if (momentum < 90) momentumLabel = "Degrading";
  if (momentum < 70) momentumLabel = "Unstable";

  // ===============================
  // üí£ SLA COLLAPSE PROBABILITY
  // ===============================

  let collapseProbability =
    (delayRisk * 0.5) +
    (anomalyIntensity * 0.3) +
    ((100 - ingestion.sla_percent) * 0.2);

  collapseProbability = Math.min(Math.round(collapseProbability), 100);

  // ===============================
  // üü¢ STATUS BANNER
  // ===============================

  const expectedInterval = 60;
  const minsToNext = expectedInterval - mins;

  let banner = document.getElementById("statusBanner");

  if (mins <= 60) {
    banner.style.background = "#052e16";
    banner.style.color = "#22c55e";
    banner.innerHTML = `üü¢ Healthy ‚Äî Next snapshot in ~${minsToNext} min`;
  }
  else if (mins <= 75) {
    banner.style.background = "#422006";
    banner.style.color = "#f59e0b";
    banner.innerHTML = `üü° Delayed ‚Äî Overdue by ${mins - 60} min`;
  }
  else {
    banner.style.background = "#3f0f12";
    banner.style.color = "#ef4444";
    banner.innerHTML = `üî¥ Critical ‚Äî No snapshot for ${mins} min`;
  }

  // ===============================
  // üìä INGESTION GRID
  // ===============================

  document.getElementById("ingestionMetrics").innerHTML =
    metric("Health Score", ingestion.health_score + "/100") +
    metric("Minutes Since Snapshot", mins) +
    metric("Row Œî %", rowDelta + "%") +
    metric("Interval Drift", drift + "m") +
    metric("Volatility Regime", volatilityRegime) +
    metric("SLA %", ingestion.sla_percent + "%") +
    metric("Avg Duration", avg + " ms") +
    metric("P95 Duration", p95 + " ms") +
    metric("Max Duration", max + " ms");

  // ===============================
  // üìà TRAFFIC GRID
  // ===============================

  document.getElementById("trafficMetrics").innerHTML =
    metric("Today Visits", traffic.today_total) +
    metric("Today Unique", traffic.today_unique) +
    metric("Yesterday Visits", traffic.yesterday_total) +
    metric("Growth %", traffic.growth_percent + "%") +
    metric("30d Total", traffic.total_30_days) +
    metric("30d Unique", traffic.unique_30_days);

  // ===============================
  // üö® ALERTS
  // ===============================

  document.getElementById("alertMetrics").innerHTML =
    metric("Alerts (48 Runs)", alerts.total_last_48_runs) +
    metric("Last Alert", alerts.last_alert_time || "None");

  // ===============================
  // üîÆ PREDICTIVE
  // ===============================

  document.getElementById("predictiveMetrics").innerHTML =
    metric("Delay Risk", delayRisk + "%") +
    metric("Predicted Duration", predictedDuration + " ms") +
    metric("Collapse Probability", collapseProbability + "%") +
    metric("Momentum", momentumLabel);

  // ===============================
  // üß† QUANT
  // ===============================

  document.getElementById("quantMetrics").innerHTML =
    metric("Z-Score", zScore.toFixed(2)) +
    metric("Anomaly Intensity", anomalyIntensity + "%") +
    metric("Anomaly Level", anomalyLevel);

  document.getElementById("probabilityMetrics").innerHTML =
  metric("Monte Carlo Delay Risk", monteCarloDelayProbability + "%") +
  metric("EWMA Trend", ewmaTrend) +
  metric("Drift Acceleration", accelerationLevel);
}

loadMonitoring();
setInterval(loadMonitoring, 60000);

</script>

</body>
</html>
